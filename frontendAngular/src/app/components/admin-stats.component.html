<div class="admin-stats-container">
  <!-- Header -->
  <mat-card class="header-card">
    <mat-card-header>
      <mat-card-title>
        <button mat-icon-button (click)="goBack()" matTooltip="Quay lại">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <mat-icon>assessment</mat-icon>
        <span>Thống kê & Báo cáo</span>
      </mat-card-title>
      <div class="spacer"></div>
      <div class="header-actions">
        <button mat-raised-button color="primary" (click)="exportReport('overview')">
          <mat-icon>download</mat-icon>
          Xuất báo cáo
        </button>
      </div>
    </mat-card-header>
  </mat-card>

  <!-- Date Filter -->
  <mat-card class="filters-card">
    <mat-card-content>
      <div class="date-filter">
        <mat-form-field appearance="outline">
          <mat-label>Từ ngày</mat-label>
          <input matInput [matDatepicker]="startPicker" [(ngModel)]="startDate">
          <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
          <mat-datepicker #startPicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Đến ngày</mat-label>
          <input matInput [matDatepicker]="endPicker" [(ngModel)]="endDate">
          <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
          <mat-datepicker #endPicker></mat-datepicker>
        </mat-form-field>

        <button mat-raised-button color="primary" (click)="applyDateFilter()">
          <mat-icon>search</mat-icon>
          Áp dụng
        </button>

        <button mat-stroked-button (click)="resetDateFilter()">
          <mat-icon>refresh</mat-icon>
          30 ngày gần đây
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Tabs -->
  <mat-tab-group class="stats-tabs">
    <!-- Overview Tab -->
    <mat-tab label="Tổng quan">
      <div class="tab-content">
        <div *ngIf="loadingOverview" class="loading-container">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Đang tải dữ liệu...</p>
        </div>

        <div *ngIf="!loadingOverview && overviewStats" class="overview-content">
          <!-- Summary Cards -->
          <div class="summary-grid">
            <mat-card class="summary-card">
              <mat-card-content>
                <div class="summary-icon users">
                  <mat-icon>people</mat-icon>
                </div>
                <div class="summary-info">
                  <h3>{{ overviewStats.totals.users }}</h3>
                  <p>Tổng số Users</p>
                  <small>{{ overviewStats.active.users }} đang hoạt động</small>
                </div>
              </mat-card-content>
            </mat-card>

            <mat-card class="summary-card">
              <mat-card-content>
                <div class="summary-icon events">
                  <mat-icon>event</mat-icon>
                </div>
                <div class="summary-info">
                  <h3>{{ overviewStats.totals.events }}</h3>
                  <p>Tổng số Events</p>
                  <small>{{ overviewStats.active.events }} đang diễn ra</small>
                </div>
              </mat-card-content>
            </mat-card>

            <mat-card class="summary-card">
              <mat-card-content>
                <div class="summary-icon organizations">
                  <mat-icon>business</mat-icon>
                </div>
                <div class="summary-info">
                  <h3>{{ overviewStats.totals.organizations }}</h3>
                  <p>Tổng số Đơn vị</p>
                </div>
              </mat-card-content>
            </mat-card>

            <mat-card class="summary-card">
              <mat-card-content>
                <div class="summary-icon attendance">
                  <mat-icon>how_to_reg</mat-icon>
                </div>
                <div class="summary-info">
                  <h3>{{ overviewStats.totals.attendance }}</h3>
                  <p>Tổng điểm danh</p>
                </div>
              </mat-card-content>
            </mat-card>
          </div>

          <!-- Attendance Stats -->
          <mat-card class="stats-card">
            <mat-card-header>
              <mat-card-title>Thống kê điểm danh (Kỳ hiện tại)</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="attendance-stats">
                <div class="stat-item">
                  <div class="stat-label">Tổng số</div>
                  <div class="stat-value">{{ overviewStats.attendance.total }}</div>
                </div>
                <div class="stat-item success">
                  <div class="stat-label">Có mặt</div>
                  <div class="stat-value">{{ overviewStats.attendance.present }}</div>
                </div>
                <div class="stat-item warning">
                  <div class="stat-label">Muộn</div>
                  <div class="stat-value">{{ overviewStats.attendance.late }}</div>
                </div>
                <div class="stat-item danger">
                  <div class="stat-label">Vắng</div>
                  <div class="stat-value">{{ overviewStats.attendance.absent }}</div>
                </div>
                <div class="stat-item pending">
                  <div class="stat-label">Chờ xác thực</div>
                  <div class="stat-value">{{ overviewStats.attendance.pending }}</div>
                </div>
                <div class="stat-item rate">
                  <div class="stat-label">Tỷ lệ điểm danh</div>
                  <div class="stat-value">{{ overviewStats.attendance.attendanceRate }}%</div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Check-in Methods -->
          <mat-card class="stats-card">
            <mat-card-header>
              <mat-card-title>Phương thức điểm danh</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="methods-stats">
                <div class="method-item wifi">
                  <mat-icon>wifi</mat-icon>
                  <div class="method-info">
                    <div class="method-label">Wi-Fi</div>
                    <div class="method-value">{{ overviewStats.checkInMethods.wifi }}</div>
                  </div>
                </div>
                <div class="method-item gps">
                  <mat-icon>location_on</mat-icon>
                  <div class="method-info">
                    <div class="method-label">GPS</div>
                    <div class="method-value">{{ overviewStats.checkInMethods.gps }}</div>
                  </div>
                </div>
                <div class="method-item manual">
                  <mat-icon>edit</mat-icon>
                  <div class="method-info">
                    <div class="method-label">Thủ công</div>
                    <div class="method-value">{{ overviewStats.checkInMethods.manual }}</div>
                  </div>
                </div>
                <div class="method-item admin">
                  <mat-icon>admin_panel_settings</mat-icon>
                  <div class="method-info">
                    <div class="method-label">Admin</div>
                    <div class="method-value">{{ overviewStats.checkInMethods.admin }}</div>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>
    </mat-tab>

    <!-- Organizations Tab -->
    <mat-tab label="Theo đơn vị">
      <div class="tab-content">
        <mat-card class="table-card">
          <mat-card-header>
            <mat-card-title>Thống kê theo đơn vị</mat-card-title>
            <div class="spacer"></div>
            <button mat-raised-button color="primary" (click)="exportReport('organizations')">
              <mat-icon>download</mat-icon>
              Xuất Excel
            </button>
          </mat-card-header>
          <mat-card-content>
            <div *ngIf="loadingOrganizations" class="loading-container">
              <mat-spinner diameter="40"></mat-spinner>
            </div>

            <div *ngIf="!loadingOrganizations && organizationStats.length === 0" class="empty-state">
              <mat-icon class="empty-icon">business_center</mat-icon>
              <p>Chưa có dữ liệu thống kê</p>
            </div>

            <div *ngIf="!loadingOrganizations && organizationStats.length > 0" class="table-container">
              <table mat-table [dataSource]="organizationStats" class="stats-table">
                <ng-container matColumnDef="name">
                  <th mat-header-cell *matHeaderCellDef>Tên đơn vị</th>
                  <td mat-cell *matCellDef="let org">
                    <strong>{{ org.organizationName }}</strong>
                    <div class="org-code" *ngIf="org.organizationCode">
                      <small>{{ org.organizationCode }}</small>
                    </div>
                  </td>
                </ng-container>

                <ng-container matColumnDef="type">
                  <th mat-header-cell *matHeaderCellDef>Loại</th>
                  <td mat-cell *matCellDef="let org">
                    <mat-chip class="type-chip">{{ org.organizationType }}</mat-chip>
                  </td>
                </ng-container>

                <ng-container matColumnDef="members">
                  <th mat-header-cell *matHeaderCellDef>Thành viên</th>
                  <td mat-cell *matCellDef="let org">{{ org.totalMembers }}</td>
                </ng-container>

                <ng-container matColumnDef="attendance">
                  <th mat-header-cell *matHeaderCellDef>Điểm danh</th>
                  <td mat-cell *matCellDef="let org">
                    <div class="attendance-breakdown">
                      <span class="present">{{ org.present }}</span> /
                      <span class="late">{{ org.late }}</span> /
                      <span class="absent">{{ org.absent }}</span>
                    </div>
                  </td>
                </ng-container>

                <ng-container matColumnDef="rate">
                  <th mat-header-cell *matHeaderCellDef>Tỷ lệ</th>
                  <td mat-cell *matCellDef="let org">
                    <mat-chip [class]="'rate-chip rate-' + getAttendanceRateColor(org.attendanceRate)">
                      {{ org.attendanceRate }}%
                    </mat-chip>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="orgDisplayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: orgDisplayedColumns;"></tr>
              </table>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>

    <!-- Events Tab -->
    <mat-tab label="Theo sự kiện">
      <div class="tab-content">
        <mat-card class="table-card">
          <mat-card-header>
            <mat-card-title>Thống kê theo sự kiện</mat-card-title>
            <div class="spacer"></div>
            <button mat-raised-button color="primary" (click)="exportReport('events')">
              <mat-icon>download</mat-icon>
              Xuất Excel
            </button>
          </mat-card-header>
          <mat-card-content>
            <div *ngIf="loadingEvents" class="loading-container">
              <mat-spinner diameter="40"></mat-spinner>
            </div>

            <div *ngIf="!loadingEvents && eventStats.length === 0" class="empty-state">
              <mat-icon class="empty-icon">event_busy</mat-icon>
              <p>Chưa có sự kiện nào trong khoảng thời gian này</p>
            </div>

            <div *ngIf="!loadingEvents && eventStats.length > 0" class="table-container">
              <table mat-table [dataSource]="eventStats" class="stats-table">
                <ng-container matColumnDef="name">
                  <th mat-header-cell *matHeaderCellDef>Tên sự kiện</th>
                  <td mat-cell *matCellDef="let event">
                    <strong>{{ event.eventName }}</strong>
                    <div class="event-location" *ngIf="event.location">
                      <small><mat-icon>place</mat-icon>{{ event.location }}</small>
                    </div>
                  </td>
                </ng-container>

                <ng-container matColumnDef="date">
                  <th mat-header-cell *matHeaderCellDef>Thời gian</th>
                  <td mat-cell *matCellDef="let event">
                    <small>{{ formatDateTime(event.startTime) }}</small>
                  </td>
                </ng-container>

                <ng-container matColumnDef="participants">
                  <th mat-header-cell *matHeaderCellDef>Người tham gia</th>
                  <td mat-cell *matCellDef="let event">{{ event.totalParticipants }}</td>
                </ng-container>

                <ng-container matColumnDef="present">
                  <th mat-header-cell *matHeaderCellDef>Có mặt</th>
                  <td mat-cell *matCellDef="let event">
                    <span class="present-count">{{ event.present }}</span>
                  </td>
                </ng-container>

                <ng-container matColumnDef="late">
                  <th mat-header-cell *matHeaderCellDef>Muộn</th>
                  <td mat-cell *matCellDef="let event">
                    <span class="late-count">{{ event.late }}</span>
                  </td>
                </ng-container>

                <ng-container matColumnDef="rate">
                  <th mat-header-cell *matHeaderCellDef>Tỷ lệ</th>
                  <td mat-cell *matCellDef="let event">
                    <mat-chip [class]="'rate-chip rate-' + getAttendanceRateColor(event.attendanceRate)">
                      {{ event.attendanceRate }}%
                    </mat-chip>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="eventDisplayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: eventDisplayedColumns;"></tr>
              </table>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>

    <!-- Top Performers Tab -->
    <mat-tab label="Xuất sắc">
      <div class="tab-content">
        <mat-card class="table-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>emoji_events</mat-icon>
              Top 10 người có tỷ lệ điểm danh cao nhất
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div *ngIf="loadingPerformers" class="loading-container">
              <mat-spinner diameter="40"></mat-spinner>
            </div>

            <div *ngIf="!loadingPerformers && topPerformers.length === 0" class="empty-state">
              <mat-icon class="empty-icon">person_off</mat-icon>
              <p>Chưa có dữ liệu</p>
            </div>

            <div *ngIf="!loadingPerformers && topPerformers.length > 0" class="table-container">
              <table mat-table [dataSource]="topPerformers" class="stats-table performers-table">
                <ng-container matColumnDef="rank">
                  <th mat-header-cell *matHeaderCellDef>Hạng</th>
                  <td mat-cell *matCellDef="let performer; let i = index">
                    <div class="rank-badge" [class.top-3]="i < 3">
                      <mat-icon *ngIf="i === 0">emoji_events</mat-icon>
                      <mat-icon *ngIf="i === 1">military_tech</mat-icon>
                      <mat-icon *ngIf="i === 2">workspace_premium</mat-icon>
                      <span *ngIf="i >= 3">{{ i + 1 }}</span>
                    </div>
                  </td>
                </ng-container>

                <ng-container matColumnDef="name">
                  <th mat-header-cell *matHeaderCellDef>Họ tên</th>
                  <td mat-cell *matCellDef="let performer">
                    <strong>{{ performer.userName }}</strong>
                  </td>
                </ng-container>

                <ng-container matColumnDef="email">
                  <th mat-header-cell *matHeaderCellDef>Email</th>
                  <td mat-cell *matCellDef="let performer">
                    <small>{{ performer.userEmail }}</small>
                  </td>
                </ng-container>

                <ng-container matColumnDef="total">
                  <th mat-header-cell *matHeaderCellDef>Tổng số</th>
                  <td mat-cell *matCellDef="let performer">{{ performer.totalAttendance }}</td>
                </ng-container>

                <ng-container matColumnDef="present">
                  <th mat-header-cell *matHeaderCellDef>Có mặt</th>
                  <td mat-cell *matCellDef="let performer">
                    <span class="present-count">{{ performer.present }}</span>
                  </td>
                </ng-container>

                <ng-container matColumnDef="rate">
                  <th mat-header-cell *matHeaderCellDef>Tỷ lệ</th>
                  <td mat-cell *matCellDef="let performer">
                    <mat-chip class="rate-chip rate-success">
                      {{ performer.attendanceRate }}%
                    </mat-chip>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="performersDisplayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: performersDisplayedColumns;"></tr>
              </table>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Poor Attendance -->
        <mat-card class="table-card" style="margin-top: 24px;">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>warning</mat-icon>
              Top 10 người có tỷ lệ điểm danh thấp (< 50%)
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div *ngIf="poorPerformers.length === 0" class="empty-state">
              <mat-icon class="empty-icon">check_circle</mat-icon>
              <p>Không có người nào có tỷ lệ điểm danh dưới 50%</p>
            </div>

            <div *ngIf="poorPerformers.length > 0" class="table-container">
              <table mat-table [dataSource]="poorPerformers" class="stats-table">
                <ng-container matColumnDef="rank">
                  <th mat-header-cell *matHeaderCellDef>#</th>
                  <td mat-cell *matCellDef="let performer; let i = index">{{ i + 1 }}</td>
                </ng-container>

                <ng-container matColumnDef="name">
                  <th mat-header-cell *matHeaderCellDef>Họ tên</th>
                  <td mat-cell *matCellDef="let performer">
                    <strong>{{ performer.userName }}</strong>
                  </td>
                </ng-container>

                <ng-container matColumnDef="email">
                  <th mat-header-cell *matHeaderCellDef>Email</th>
                  <td mat-cell *matCellDef="let performer">
                    <small>{{ performer.userEmail }}</small>
                  </td>
                </ng-container>

                <ng-container matColumnDef="total">
                  <th mat-header-cell *matHeaderCellDef>Tổng số</th>
                  <td mat-cell *matCellDef="let performer">{{ performer.totalAttendance }}</td>
                </ng-container>

                <ng-container matColumnDef="absent">
                  <th mat-header-cell *matHeaderCellDef>Vắng</th>
                  <td mat-cell *matCellDef="let performer">
                    <span class="absent-count">{{ performer.absent }}</span>
                  </td>
                </ng-container>

                <ng-container matColumnDef="rate">
                  <th mat-header-cell *matHeaderCellDef>Tỷ lệ</th>
                  <td mat-cell *matCellDef="let performer">
                    <mat-chip class="rate-chip rate-danger">
                      {{ performer.attendanceRate }}%
                    </mat-chip>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="poorDisplayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: poorDisplayedColumns;"></tr>
              </table>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>
