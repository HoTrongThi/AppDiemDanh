<div class="attendance-history-container">
  <!-- Header -->
  <mat-toolbar color="primary">
    <button mat-icon-button (click)="goBack()" matTooltip="Quay lại">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <span class="title">Lịch sử điểm danh</span>
    <span class="spacer"></span>
    <span class="user-info">
      <mat-icon>person</mat-icon>
      {{ currentUser?.fullName }}
    </span>
  </mat-toolbar>

  <div class="content-container">
    <!-- Stats Cards -->
    <div class="stats-grid">
      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-content">
            <div class="stat-icon total">
              <mat-icon>event</mat-icon>
            </div>
            <div class="stat-info">
              <div class="stat-number">{{ stats.total }}</div>
              <div class="stat-label">Tổng sự kiện</div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-content">
            <div class="stat-icon present">
              <mat-icon>check_circle</mat-icon>
            </div>
            <div class="stat-info">
              <div class="stat-number">{{ stats.present }}</div>
              <div class="stat-label">Có mặt</div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-content">
            <div class="stat-icon late">
              <mat-icon>schedule</mat-icon>
            </div>
            <div class="stat-info">
              <div class="stat-number">{{ stats.late }}</div>
              <div class="stat-label">Muộn</div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-content">
            <div class="stat-icon rate">
              <mat-icon>trending_up</mat-icon>
            </div>
            <div class="stat-info">
              <div class="stat-number">{{ stats.attendanceRate }}%</div>
              <div class="stat-label">Tỷ lệ tham gia</div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Filters -->
    <mat-card class="filters-card">
      <mat-card-content>
        <div class="filters-row">
          <mat-form-field appearance="outline" class="search-field">
            <mat-label>Tìm kiếm</mat-label>
            <input matInput [(ngModel)]="searchText" (ngModelChange)="onSearchChange()" 
                   placeholder="Tên sự kiện, địa điểm...">
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Trạng thái</mat-label>
            <mat-select [(value)]="statusFilter" (selectionChange)="onStatusFilterChange()">
              <mat-option *ngFor="let option of statusOptions" [value]="option.value">
                {{ option.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="date-field">
            <mat-label>Từ ngày</mat-label>
            <input matInput [matDatepicker]="startDatePicker" [(ngModel)]="startDate" 
                   (ngModelChange)="onDateRangeChange()">
            <mat-datepicker-toggle matSuffix [for]="startDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #startDatePicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline" class="date-field">
            <mat-label>Đến ngày</mat-label>
            <input matInput [matDatepicker]="endDatePicker" [(ngModel)]="endDate" 
                   (ngModelChange)="onDateRangeChange()">
            <mat-datepicker-toggle matSuffix [for]="endDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #endDatePicker></mat-datepicker>
          </mat-form-field>

          <div class="actions-section">
            <button mat-button (click)="clearFilters()">
              <mat-icon>clear</mat-icon>
              Xóa bộ lọc
            </button>
            <button mat-raised-button color="primary" (click)="exportToCSV()">
              <mat-icon>download</mat-icon>
              Xuất CSV
            </button>
          </div>
        </div>

        <div class="results-info">
          <span class="results-count">
            {{ filteredRecords.length }} / {{ attendanceRecords.length }} bản ghi
          </span>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Attendance Table -->
    <mat-card class="table-card">
      <mat-card-content>
        <div *ngIf="isLoading" class="loading-container">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Đang tải lịch sử điểm danh...</p>
        </div>

        <div *ngIf="!isLoading && attendanceRecords.length === 0" class="empty-state">
          <mat-icon class="empty-icon">event_busy</mat-icon>
          <h3>Chưa có lịch sử điểm danh</h3>
          <p>Bạn chưa tham gia sự kiện nào hoặc chưa có dữ liệu điểm danh.</p>
        </div>

        <div *ngIf="!isLoading && attendanceRecords.length > 0 && filteredRecords.length === 0" class="no-results">
          <mat-icon class="no-results-icon">search_off</mat-icon>
          <h3>Không tìm thấy bản ghi</h3>
          <p>Không có bản ghi nào phù hợp với bộ lọc hiện tại.</p>
          <button mat-button (click)="clearFilters()">
            Xóa bộ lọc
          </button>
        </div>

        <div *ngIf="!isLoading && filteredRecords.length > 0" class="table-container">
          <table mat-table [dataSource]="filteredRecords" class="attendance-table">
            <!-- Event Name Column -->
            <ng-container matColumnDef="eventName">
              <th mat-header-cell *matHeaderCellDef>Sự kiện</th>
              <td mat-cell *matCellDef="let record">
                <div class="event-name-cell">
                  <div class="event-name">{{ record.eventName || 'Không xác định' }}</div>
                  <div class="event-id">ID: {{ record.eventId }}</div>
                </div>
              </td>
            </ng-container>

            <!-- Event Date Column -->
            <ng-container matColumnDef="eventDate">
              <th mat-header-cell *matHeaderCellDef>Ngày</th>
              <td mat-cell *matCellDef="let record">
                <div class="date-cell">
                  <div class="date">{{ formatDate(record.eventDate) }}</div>
                </div>
              </td>
            </ng-container>

            <!-- Event Location Column -->
            <ng-container matColumnDef="eventLocation">
              <th mat-header-cell *matHeaderCellDef>Địa điểm</th>
              <td mat-cell *matCellDef="let record">
                <div class="location-cell">
                  <mat-icon>location_on</mat-icon>
                  <span>{{ record.eventLocation || 'Không xác định' }}</span>
                </div>
              </td>
            </ng-container>

            <!-- Status Column -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Trạng thái</th>
              <td mat-cell *matCellDef="let record">
                <div class="status-cell">
                  <mat-chip [color]="getStatusColor(record.status)" selected>
                    <mat-icon>{{ getStatusIcon(record.status) }}</mat-icon>
                    {{ getStatusLabel(record.status) }}
                  </mat-chip>
                  <div class="status-notes" *ngIf="record.notes">
                    <mat-icon matTooltip="{{ record.notes }}">info</mat-icon>
                  </div>
                </div>
              </td>
            </ng-container>

            <!-- Check-in Time Column -->
            <ng-container matColumnDef="checkInTime">
              <th mat-header-cell *matHeaderCellDef>Thời gian điểm danh</th>
              <td mat-cell *matCellDef="let record">
                <div class="checkin-time-cell">
                  <div class="time" [ngClass]="{ 'late': isLateCheckIn(record) }">
                    {{ formatTime(record.checkInTime) }}
                  </div>
                  <div class="verified" *ngIf="record.verifiedBy">
                    <mat-icon matTooltip="Xác nhận bởi {{ record.verifiedBy }}">verified</mat-icon>
                  </div>
                </div>
              </td>
            </ng-container>

            <!-- Check-in Method Column -->
            <ng-container matColumnDef="checkInMethod">
              <th mat-header-cell *matHeaderCellDef>Phương thức</th>
              <td mat-cell *matCellDef="let record">
                <div class="method-cell" *ngIf="record.checkInMethod">
                  <mat-icon>{{ getCheckInMethodIcon(record.checkInMethod) }}</mat-icon>
                  <span>{{ getCheckInMethodLabel(record.checkInMethod) }}</span>
                  <mat-icon class="gps-icon" *ngIf="hasGpsLocation(record)" 
                           matTooltip="Có dữ liệu GPS">gps_fixed</mat-icon>
                </div>
                <span *ngIf="!record.checkInMethod">-</span>
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Thao tác</th>
              <td mat-cell *matCellDef="let record">
                <div class="actions-cell">
                  <button mat-icon-button (click)="viewEventDetail(record)" 
                          matTooltip="Xem chi tiết sự kiện">
                    <mat-icon>visibility</mat-icon>
                  </button>
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" 
                class="attendance-row" 
                [ngClass]="{ 
                  'present': row.status === 'Present',
                  'late': row.status === 'Late',
                  'absent': row.status === 'Absent',
                  'pending': row.status === 'Pending'
                }"
                (click)="viewEventDetail(row)"></tr>
          </table>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>